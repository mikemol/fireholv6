#!/usr/bin/make -f
# First try in creating a debian/rules-file.

build:
	touch build-stamp

clean:
	-rm -f build
	-rm -rf debian/*substvars debian/tmp debian/files

binary:	binary-indep binary-arch

binary-indep:	checkroot build
	#Create the directories:
	install -d debian/tmp/DEBIAN
	install -d debian/tmp/sbin/
	install -d debian/tmp/usr/sbin
	install -d debian/tmp/etc/firehol
	install -d debian/tmp/etc/firehol/services
	install -d debian/tmp/etc/default
	install -d debian/tmp/etc/init.d
	install -d debian/tmp/usr/share/man/man1/
	install -d debian/tmp/usr/share/man/man5/
	install -d debian/tmp/usr/share/doc/firehol
	install -d debian/tmp/usr/share/doc/firehol/html
	install -d debian/tmp/usr/share/doc/firehol/examples

	#Install the scripts and the config:
	install -m 755 firehol.sh debian/tmp/sbin/firehol
	install -m 755 debian/init.d/firehol debian/tmp/etc/init.d/firehol
	install -m 644 examples/client-all.conf debian/tmp/etc/firehol/firehol.conf
	install -m 644 debian/RESERVED_IPV4 debian/tmp/etc/firehol
	install -m 644 debian/RESERVED_IPV6 debian/tmp/etc/firehol
	install -m 755 get-iana.sh debian/tmp/usr/sbin/get-iana
	sed -i -e 's/aggregate-flim/aggregate/g' debian/tmp/usr/sbin/get-iana

	echo "#To enable firehol at startup set START_FIREHOL=YES" > debian/tmp/etc/default/firehol
	echo "START_FIREHOL=NO" >> debian/tmp/etc/default/firehol
	echo "#If you want to have firehol wait for an iface to be up add it here" >> debian/tmp/etc/default/firehol
	echo 'WAIT_FOR_IFACE=""' >> debian/tmp/etc/default/firehol
	
	chmod 644 debian/tmp/etc/default/firehol

	#Copy the documentation:
	install -m 644 debian/README.Debian debian/README.Services debian/tmp/usr/share/doc/firehol/
	install -m 644 doc/*.html doc/*.css debian/tmp/usr/share/doc/firehol/html/
	install -m 644 man/firehol.1 debian/tmp/usr/share/man/man1/
	install -m 644 debian/get-iana.1 debian/tmp/usr/share/man/man1/
	install -m 644 man/firehol.conf.5 debian/tmp/usr/share/man/man5/
	gzip -9 debian/tmp/usr/share/man/man1/firehol.1 debian/tmp/usr/share/man/man5/firehol.conf.5 debian/tmp/usr/share/man/man1/get-iana.1

	#Copy the examples:
	install -m 644 examples/*.conf debian/tmp/usr/share/doc/firehol/examples/
	install -m 644 adblock.sh  debian/tmp/usr/share/doc/firehol/examples/
	install -m 644 debian/bittorrent.conf debian/tmp/usr/share/doc/firehol/examples/
	
	#Copyright, Changelog, etc:
	install -m 644 debian/copyright debian/tmp/usr/share/doc/firehol/
	install -m 644 debian/changelog debian/tmp/usr/share/doc/firehol/changelog.Debian
	gzip -9 debian/tmp/usr/share/doc/firehol/changelog.Debian
	install -m 644 ChangeLog debian/tmp/usr/share/doc/firehol/changelog
	gzip -9 debian/tmp/usr/share/doc/firehol/changelog

	install -m 644 WhatIsNew README TODO debian/tmp/usr/share/doc/firehol/

	#Create MD5-Sums:
	(cd debian/tmp; find -type f | sed s#^./## | grep -v DEBIAN | xargs md5sum > DEBIAN/md5sums)
	chmod 644 debian/tmp/DEBIAN/md5sums

	# Standard package building stuff
	install -m755 debian/postinst debian/tmp/DEBIAN
	install -m755 debian/postrm debian/tmp/DEBIAN
	install -m644 debian/conffiles debian/tmp/DEBIAN
	dpkg-gencontrol -pfirehol -is -ip
	chmod 644 debian/tmp/DEBIAN/control
	chown -R root:root debian/tmp
	dpkg --build debian/tmp ..

binary-arch:	checkroot build
	# No architecture dependent packages

checkroot:
	test root = "`whoami`"

.PHONY: binary clean binary-indep binary-arch build install clean
